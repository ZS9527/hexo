---
title: 记优化主从同步恢复时间的过程
date: 2020-06-12 21:11:31
tags: Mysql
---
# 记优化主从同步恢复时间的过程
> 这次再次出现了 Mysql 主从同步时，出现了主键冲突错误。当再次采用Data文件夹复制的时候。发现随着二级制日志文件的越来越多，复制的时间也越来越长。在复制恢复的时候无法启动程序，客户感觉体验极差（虽然原因是因为客户那边的服务器断电了，但是技术方面还是可以去避免这种情况的出现）。

<!--more-->

## 主从同步的基础原理
从数据库( Slave )是主数据库的备份，当主数据库( Master )变化时从数据库要更新，这些数据库软件可以设计更新周期。这是提高信息安全的手段。

Mysql 服务器之间的主从同步是基于二进制日志机制，主服务器使用二进制日志来记录数据库的变动情况，从服务器通过读取和执行该日志文件来保持和主服务器的数据一致。

在使用二进制日志时，主服务器的所有操作都会被记录下来，然后从服务器会接收到该日志的一个副本。从服务器可以指定执行该日志中的哪一类事件（譬如只插入数据或者只更新数据），默认会执行日志中的所有语句。

每一个从服务器会记录关于二进制日志的信息：文件名和已经处理过的语句，这样意味着不同的从服务器可以分别执行同一个二进制日志的不同部分，并且从服务器可以随时连接或者中断和服务器的连接。

主服务器和每一个从服务器都必须配置一个唯一的ID号（在 my.ini 文件的[ mysqld ]模块下有一个 server-id 配置项），另外，每一个从服务器还需要通过 CHANGE MASTER TO 语句来配置它要连接的主服务器的 ip 地址，日志文件名称和该日志里面的位置（这些信息存储在主服务器的数据库里）

Mysql 的主从复制涉及到三个线程
1. 主节点 binary log dump 线程
当从节点连接主节点时，主节点会创建一个 log dump 线程，用于发送 bin-log 的内容。在读取bin-log 中的操作时，此线程会对主节点上的 bin-log 加锁，当读取完成，甚至在发动给从节点之前，锁会被释放。
2. 从节点 I/O 线程
当从节点上执行`start slave`命令之后，从节点会创建一个I/O线程用来连接主节点，请求主库中更新的 bin-log。I/O线程接收到主节点 binlog dump 进程发来的更新之后，保存在本地relay-log 中。
3. 从节点 SQL 线程
SQL线程负责读取relay log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。
对于每一个主从连接，都需要三个进程来完成。当主节点有多个从节点时，主节点会为每一个当前连接的从节点建一个 binary log dump 进程，而每个从节点都有自己的 I/O 进程，SQL 进程。从节点用两个线程将从主库拉取更新和执行分成独立的任务，这样在执行同步数据任务的时候，不会降低读操作的性能。比如，如果从节点没有运行，此时I/O进程可以很快从主节点获取更新，尽管 SQL 进程还没有执行。如果在 SQL 进程执行之前从节点服务停止，至少 I/O 进程已经从主节点拉取到了最新的变更并且保存在本地 relay 日志中，当服务再次起来之后，就可以完成数据的同步。

![](b1.png)

## 初步尝试，去除二进制文件
想了想，既然从库复制数据是从二进制文件中读取。那么已经同步完的数据就可以将其二进制文件删除。便在配置文件中加入了
```
#设置binlog清理时间
expire_logs_days=7
```

## 常见处理，跳过错误sql语句
网上更加常见的一种方式是跳过错误sql：
```sql
stop slave;
set global sql_slave_skip_counter=1;
start slave;
show slave status;
```
但是这种方式会丢失数据，比如当从库已经占用了 id 为1的主键，主库写入 id 为1和2的数据。当跳过时就会丢失主库 id 为1的记录。

跳过后看似主从同步已经恢复，实际上一旦主库再次操作 id 为1的记录。从库中没有时，依旧会主从同步失败。

## 结论
在不丢失数据的情况下出现了主键冲突错误，暂时加快恢复的方式是删除多余的二进制文件。