---
title: FTP断开连接，并返回421错误码
date: 2021-01-25 18:49:04
tags: ftp
---

# FTP断开连接，并返回421错误码
> 这个问题搞了好久。办公地点机房搬迁，导致网络及其不稳定。
> 421 received. Server closed connection
> FTP 无法远程连接
<!--more-->

## 报错情况与解决思路
一开始的报错情况是可以在本机连接自己的 FTP，在其他服务器上不行。使用命令
```
service iptables stop
```
关闭了防火墙后，成功解决问题。

这边使用的是 hutool 提供的 FTP 工具类。在返回错误时，只返回了
```
421 received. Server closed connection
```

一开始百度到的回答是说连接数过多，我查了一下FTP配置文件，连接数是默认无限制的。
```
max_per_ip 
如果vsftpd处于独立模式，则这是可以从同一源Internet地址连接的最大客户端数。
如果客户端超过此限制，则会收到错误消息。
默认值：0（无限制）
```
然后经过程序多次尝试，发现和FTP连接时间有关。
```
data_connection_timeout
超时（以秒为单位），大约是我们允许数据传输暂停而没有任何进展的最长时间。
如果超时触发，则启动远程客户端。
默认值：300

accept_timeout
远程客户端与PASV样式数据连接建立连接的超时时间（以秒为单位）。
默认值：60

```
尝试提高连接时间并将不需要 FTP 处理的程序抽离出来，成功解决问题。


